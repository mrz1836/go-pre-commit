# ------------------------------------------------------------------------------------
#  Test MAGE-X (Reusable Workflow) (GoFortress)
#
#  Purpose: Verify that MAGE-X is installed and working correctly with standard
#  magex commands. This is a prerequisite for other workflows that use magex commands.
#
#  Maintainer: @mrz1836
#
# ------------------------------------------------------------------------------------

name: GoFortress (Test MAGE-X)

on:
  workflow_call:
    inputs:
      env-json:
        description: "JSON string of environment variables"
        required: true
        type: string
      primary-runner:
        description: "Primary runner OS"
        required: true
        type: string

# Security: Restrictive default permissions with job-level overrides for least privilege access
permissions:
  contents: read

jobs:
  # ----------------------------------------------------------------------------------
  # Test MAGE-X (Installation and Command Verification)
  # ----------------------------------------------------------------------------------
  test-magex:
    name: ðŸª„ Verify & Test MAGE-X
    runs-on: ${{ inputs.primary-runner }}
    steps:
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Parse environment variables
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ðŸ”§ Parse environment variables
        env:
          ENV_JSON: ${{ inputs.env-json }}
        run: |
          echo "ðŸ“‹ Setting environment variables..."
          echo "$ENV_JSON" | jq -r 'to_entries | .[] | "\(.key)=\(.value)"' | while IFS='=' read -r key value; do
            echo "$key=$value" >> $GITHUB_ENV
          done

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Checkout code (sparse checkout)
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ðŸ“¥ Checkout (sparse)
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0 # Required for sparse checkout
          sparse-checkout: |
            .github/.env.base
            .github/actions/setup-magex
            .mage.yaml
            go.mod
            go.sum

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Setup MAGE-X using the reusable composite action
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ðŸ”§ Setup MAGE-X
        id: setup-magex
        uses: ./.github/actions/setup-magex
        with:
          magex-version: ${{ env.MAGE_X_VERSION }}
          runner-os: ${{ inputs.primary-runner }}

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Verify MAGE-X installation and required commands
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: âœ… Verify magex help and required commands
        id: verify-magex
        run: |
          echo "ðŸ“‹ Testing for required magex commands..."

          # Capture help output
          HELP_OUTPUT=$(magex help)

          echo "$HELP_OUTPUT"

          # List of required magex commands
          REQUIRED_COMMANDS=(
            "bench"
            "clean"
            "deps:download"
            "deps:update"
            "format:fix"
            "lint"
            "metrics:coverage"
            "metrics:loc"
            "release"
            "release:validate"
            "test"
            "test:cover"
            "test:coverrace"
            "test:fuzz"
            "test:race"
            "tidy"
            "update:install"
            "version:bump"
            "vet"
          )

          MATCHED_COUNT=0
          MISSING_COUNT=0
          MISSING_COMMANDS=()

          echo ""
          echo "ðŸ” Verifying required magex commands..."

          for cmd in "${REQUIRED_COMMANDS[@]}"; do
            if echo "$HELP_OUTPUT" | grep -qE "^[[:space:]]*$cmd[[:space:]]"; then
              echo "âœ… Found: $cmd"
              MATCHED_COUNT=$((MATCHED_COUNT + 1))
            else
              echo "âŒ Missing required command: $cmd"
              MISSING_COMMANDS+=("$cmd")
              MISSING_COUNT=$((MISSING_COUNT + 1))
            fi
          done

          echo ""
          echo "âœ… Matched: $MATCHED_COUNT"
          echo "âŒ Missing: $MISSING_COUNT"

          echo "matched=$MATCHED_COUNT" >> "$GITHUB_OUTPUT"
          echo "missing=$MISSING_COUNT" >> "$GITHUB_OUTPUT"
          echo "missing_commands=${MISSING_COMMANDS[*]}" >> "$GITHUB_OUTPUT"

          # Fail if anything is missing
          if [ $MISSING_COUNT -gt 0 ]; then
            echo ""
            echo "ðŸš¨ Missing MAGE-X commands:"
            printf ' - %s\n' "${MISSING_COMMANDS[@]}"
            exit 1
          fi

          echo ""
          echo "âœ… MAGE-X verification completed successfully."

      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Summary of MAGE-X verification
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ðŸ“Š Job Summary
        run: |
          echo "## ðŸª„ MAGE-X Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”§ Verification Details | âœ… Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| **Test** | magex help command |" >> $GITHUB_STEP_SUMMARY
          echo "| **Installation** | ${{ steps.setup-magex.outputs.installation-method == 'cached' && 'ðŸ’¾ From cache' || 'ðŸ“¥ Fresh install' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Purpose** | Verify MAGE-X installation and standard commands |" >> $GITHUB_STEP_SUMMARY
          echo "| **Matched Commands** | ${{ steps.verify-magex.outputs.matched }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Missing Commands** | ${{ steps.verify-magex.outputs.missing }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ steps.verify-magex.outputs.missing }}" != "0" ]]; then
            echo "ðŸš¨ **Missing Commands:** ${{ steps.verify-magex.outputs.missing_commands }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸŽ¯ **MAGE-X is properly configured and functional.**" >> $GITHUB_STEP_SUMMARY
          fi
